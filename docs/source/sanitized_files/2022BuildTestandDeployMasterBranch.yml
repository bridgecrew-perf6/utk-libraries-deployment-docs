- pipeline: "2022 Build, Test and Deploy Master Branch"
  on: "EVENT"
  events:
  - type: "PUSH"
    refs:
    - "refs/heads/master"
  priority: "NORMAL"
  fetch_all_refs: true
  fail_on_prepare_env_warning: true
  actions:
  - action: "Install/Test"
    type: "BUILD"
    working_directory: "/buddy/utk-libraries"
    docker_image_name: "library/php"
    docker_image_tag: "7.2-stretch"
    execute_commands:
    - "cd /buddy/utk-libraries/$theme"
    - "composer clear-cache"
    - "composer install -vvv"
    setup_commands:
    - "echo \"memory_limit=-1\" >> /usr/local/etc/php/conf.d/buddy.ini"
    - "apt-get update && apt-get install -y git zip"
    - "curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer"
    - "# php ext gd"
    - "apt-get install -y libfreetype6-dev"
    - "apt-get install -y libjpeg62-turbo-dev"
    - "apt-get install -y libpng-dev"
    - "docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ --with-png-dir=/usr/include/"
    - "docker-php-ext-install gd"
    - "# php ext zip"
    - "apt-get install -y zip"
    - "apt-get install -y unzip"
    - "apt-get install -y zlib1g-dev"
    - "docker-php-ext-install zip"
    - "# php ext pdo_mysql"
    - "docker-php-ext-configure pdo_mysql --with-pdo-mysql"
    - "docker-php-ext-install pdo_mysql"
    volume_mappings:
    - "/:/buddy/utk-libraries"
    shell: "BASH"
  - action: "Build React Apps & Sage 9 theme"
    type: "BUILD"
    working_directory: "/buddy/utk-libraries"
    docker_image_name: "library/node"
    docker_image_tag: "10"
    execute_commands:
    - "# build react apps"
    - "cd $react"
    - "cd accordion && yarn && yarn build"
    - "cd ../exhibits && yarn && yarn build"
    - "cd ../header && yarn && yarn build"
    - "cd ../panel && yarn && yarn build"
    - "cd ../social && yarn && yarn build"
    - "cd ../subsite-menu && yarn && yarn build"
    - ""
    - "# build theme"
    - "cd /buddy/utk-libraries/$theme"
    - "yarn install"
    - "yarn"
    - "yarn build:production-clean"
    - ""
    - "rm -rf node_modules"
    setup_commands:
    - "npm install -g gulp grunt-cli"
    volume_mappings:
    - "/:/buddy/utk-libraries"
    shell: "BASH"
    variables:
    - key: "react"
      value: "wp-content/mu-plugins/utk_library/src/React"
      type: "VAR"
    trigger_conditions:
    - trigger_condition: "ALWAYS"
  - action: "Set patch version"
    type: "BUILD"
    working_directory: "/buddy/utk-libraries"
    docker_image_name: "library/ubuntu"
    docker_image_tag: "18.04"
    execute_commands:
    - "# Set Path to Current Value Plus 1"
    - "((patch=patch+1))"
    - ""
    - "# Concatenate Semantic Version Number to $major.$minor.$patch"
    - "latest_version=$major\".\"$minor\".\"$patch"
    - ""
    - "# Create New Tag Equal to Current Semantic Versioning Number"
    - "git tag \"$latest_version\""
    setup_commands:
    - "apt-get update && apt-get -y install git"
    volume_mappings:
    - "/:/buddy/utk-libraries"
    shell: "BASH"
    trigger_conditions:
    - trigger_condition: "ALWAYS"
  - action: "Push patch release"
    type: "BUILD"
    working_directory: "/buddy/utk-libraries"
    docker_image_name: "library/ubuntu"
    docker_image_tag: "18.04"
    execute_commands:
    - "# ssh & git clone"
    - "echo -e 'ssh-rsa ###REPLACE_HASH### utk-libraries-1 Key\\n' >> ~/.ssh/authorized_keys"
    - "chmod 0600 ~/.ssh/authorized_keys"
    - "ssh-keyscan github.com >> /root/.ssh/known_hosts"
    - ""
    - "# Make Git User Buddy Bot"
    - "git config --global user.email \"dlcontact@utk.edu\""
    - "git config --global user.name \"UTK Buddy Bot\""
    - ""
    - "# Set remote to UTK GitHub and Push our new Tagged Release"
    - "git remote set-url origin git@github.com:utkdigitalinitiatives/utk-libraries.git"
    - "git push origin master --tags"
    - ""
    setup_commands:
    - "apt-get update && apt-get -y install git"
    volume_mappings:
    - "/:/buddy/utk-libraries"
    shell: "BASH"
    trigger_conditions:
    - trigger_condition: "ALWAYS"
  - action: "Find & replace"
    type: "REPLACE"
    local_path: "$theme/.gitignore"
    replacements:
    - replace_from: "dist/*"
      replace_to: ""
    - replace_from: "dist"
      replace_to: ""
    - replace_from: "vendor/*"
      replace_to: ""
    - replace_from: "vendor"
      replace_to: ""
  - action: "Find & replace"
    type: "REPLACE"
    local_path: "wp-content/mu-plugins/utk_library/assets/.gitignore"
    replacements:
    - replace_from: "react"
      replace_to: ""
  - action: "Push to Pantheon utk-libraries (master)"
    type: "PUSH"
    git_auth_mode: "ENV_KEY"
    env_key: "secure!###REPLACED_VALUE###"
    push_url: "ssh://codeserver.dev.###REPLACED LOCATION###:2222/~/repository.git"
    comment: "Build $BUDDY_EXECUTION_ID of $BUDDY_EXECUTION_REVISION_MESSAGE  $BUDDY_EXECUTION_REVISION"
    trigger_conditions:
    - trigger_condition: "ALWAYS"
  - action: "Push to Pantheon utk-libraries (sandbox)"
    type: "PUSH"
    git_auth_mode: "ENV_KEY"
    env_key: "secure!###REPLACED_VALUE###"
    target_branch: "sandbox"
    push_url: "ssh://codeserver.dev.###REPLACED_LOCATION###.drush.in:2222/~/repository.git"
    comment: "Build $BUDDY_EXECUTION_ID of $BUDDY_EXECUTION_REVISION_MESSAGE  $BUDDY_EXECUTION_REVISION"
    trigger_conditions:
    - trigger_condition: "ALWAYS"
  - action: "Push to UT Libraries Pantheon upstream"
    type: "PUSH"
    push_tags: true
    git_auth_mode: "ENV_KEY"
    env_key: "secure!###REPLACED_VALUE###"
    target_branch: "master"
    push_url: "git@github.com:utkdigitalinitiatives/utk-libraries-upstream.git"
    comment: "Build $BUDDY_EXECUTION_ID of $BUDDY_EXECUTION_REVISION_MESSAGE  $BUDDY_EXECUTION_REVISION"
  - action: "Run 2022 utk-libraries/Apply Upstream Updates"
    type: "RUN_NEXT_PIPELINE"
    comment: "Triggered by $BUDDY_PIPELINE_NAME execution #$BUDDY_EXECUTION_ID"
    revision: "INHERIT"
    next_project_name: "utk-libraries-1"
    next_pipeline_name: "Apply Upstream Updates"
  trigger_conditions:
  - trigger_condition: "ALWAYS"
  variables:
  - key: "printing_plugin"
    value: "wp-content/plugins/utk-wp-lib-print"
    type: "VAR"
